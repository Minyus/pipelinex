## Integration of Kedro with MLflow as Kedro DataSet and Hooks (callbacks)

- [pipelinex.extras.hooks](https://github.com/Minyus/pipelinex/tree/master/src/pipelinex/extras/hooks) provides Kedro hooks (callbacks) to use MLflow without adding any MLflow-related code in the node (task) functions.

  - [`pipelinex.MLflowBasicLoggerHook`](https://github.com/Minyus/pipelinex/blob/master/src/pipelinex/extras/hooks/mlflow/mlflow_basic_logger.py): Configures and logs duration time for the pipeline to MLflow with args:
  
    - enable_mlflow: Enable configuring and logging to MLflow.
    - uri: `uri` arg fed to:
        https://www.mlflow.org/docs/latest/python_api/mlflow.html#mlflow.set_tracking_uri
        as the MLflow tracking server URI.
        Local file path, databases supported by SQLAlchemy (sqlite, mysql, mssql, and 
        postgresql), HTTP server, Databricks workspace are supported. 
        See MLflow's document at:
        https://mlflow.org/docs/latest/tracking.html#where-runs-are-recorded
    - experiment_name: `name` arg fed to:
        https://www.mlflow.org/docs/latest/python_api/mlflow.html#mlflow.create_experiment
        as the MLflow experiment name.
    - artifact_location: `artifact_location` arg fed to:
        https://www.mlflow.org/docs/latest/python_api/mlflow.html#mlflow.create_experiment
        as the URI to store the artifacts.
        Local file paths, Amazon S3, Azure Blob Storage, Google Cloud Storage, SFTP server, 
        NFS, and HDFS are supported. 
        See MLflow's document at:
        https://mlflow.org/docs/latest/tracking.html#id10
    - run_name: Shown as 'Run Name' in the MLflow UI.
    - offset_hours: The offset hour (e.g. 0 for UTC+00:00) used for `__time_begin` and `__time_end` parameters. 

  - [`pipelinex.MLflowArtifactsLoggerHook`](https://github.com/Minyus/pipelinex/blob/master/src/pipelinex/extras/hooks/mlflow/mlflow_artifacts_logger.py): Logs artifacts of specified file paths and dataset names to MLflow with args:

    - enable_mlflow: Enable logging to MLflow.
    - filepaths_before_pipeline_run: The file paths of artifacts to log before the pipeline is run.
    - datasets_after_node_run: The dataset names to log after the node is run.
    - filepaths_after_pipeline_run: The file paths of artifacts to log after the pipeline is run.
  
  - [`pipelinex.MLflowDataSetsLoggerHook`](https://github.com/Minyus/pipelinex/blob/master/src/pipelinex/extras/hooks/mlflow/mlflow_outputs_logger.py): Logs datasets of (list of) float/int and str classes to MLflow with arg:

    - enable_mlflow: Enable logging to MLflow.
  
  - [`pipelinex.MLflowTimeLoggerHook`](https://github.com/Minyus/pipelinex/blob/master/src/pipelinex/extras/hooks/mlflow/mlflow_time_logger.py): Logs duration time for each node (task) to MLflow and optionally visualizes the execution logs as a Gantt chart by [`plotly.figure_factory.create_gantt`](https://plotly.github.io/plotly.py-docs/generated/plotly.figure_factory.create_gantt.html) if `plotly` is installed, with args:
    - enable_mlflow: Enable logging to MLflow.
    - enable_plotly: Enable visualization of logged time as a gantt chart.
    - gantt_filepath: File path to save the generated gantt chart.
    - gantt_params: Args fed to:
        https://plotly.github.io/plotly.py-docs/generated/plotly.figure_factory.create_gantt.html
    - metric_name_prefix: Prefix for the metric names. The metric names are
        - `metric_name_prefix` concatenated with the string returned by `task_name_func`.
    - task_name_func: Callable to return the task name using ``kedro.pipeline.node.Node``
        - object.
  
  - [`pipelinex.AddTransformersHook`](https://github.com/Minyus/pipelinex/blob/master/src/pipelinex/extras/hooks/add_transformers.py): Adds Kedro transformers such as:
    - [`pipelinex.MLflowIOTimeLoggerTransformer`](https://github.com/Minyus/pipelinex/blob/master/src/pipelinex/extras/transformers/mlflow/mlflow_io_time_logger.py): Logs duration time to load and save each dataset with args:
      - enable_mlflow: Enable logging to MLflow.
      - metric_name_prefix: Prefix for the metric names. The metric names are `metric_name_prefix` concatenated with 'load <data_set_name>' or 'save <data_set_name>'

  To use these hooks for MLFlow, please use the [Kedro starters](https://github.com/Minyus/kedro-starters-sklearn) which includes the following example:

  ```python
  import pipelinex

  mlflow_hooks = (
    pipelinex.MLflowBasicLoggerHook(
        enable_mlflow=True,  # Enable configuring and logging to MLflow
        uri="sqlite:///mlruns/sqlite.db",
        experiment_name="experiment_001",
        artifact_location="./mlruns/experiment_001",
        offset_hours=0,  # Specify the offset hour (e.g. 0 for UTC/GMT +00:00) to log in MLflow
    ),  # Configure and log duration time for the pipeline
    pipelinex.MLflowArtifactsLoggerHook(
        enable_mlflow=True,  # Enable logging to MLflow
        filepaths_before_pipeline_run=[
            "conf/base/parameters.yml"
        ],  # Optionally specify the file paths to log before pipeline is run
        filepaths_after_pipeline_run=[
            "data/06_models/model.pkl"
        ],  # Optionally specify the file paths to log after pipeline is run
    ),  # Log artifacts of specified file paths and dataset names
    pipelinex.MLflowDataSetsLoggerHook(
        enable_mlflow=True,  # Enable logging to MLflow
    ),  # Log output datasets of (list of) float, int, and str classes
    pipelinex.MLflowTimeLoggerHook(
        enable_mlflow=True,  # Enable logging to MLflow
    ),  # Log duration time to run each node (task)
    pipelinex.AddTransformersHook(
        transformers=[
            pipelinex.MLflowIOTimeLoggerTransformer(
                enable_mlflow=True
            )  # Log duration time to load and save each dataset
        ],
    ),  # Add transformers
  )
  ``` 

<p align="center">
<img src="https://raw.githubusercontent.com/Minyus/pipelinex/master/_doc_images/mlflow_ui_metrics.png">
Logged metrics shown in MLflow's UI
</p>

<p align="center">
<img src="https://raw.githubusercontent.com/Minyus/pipelinex/master/_doc_images/mlflow_ui_gantt.png">
Gantt chart for execution time, generated using Plotly, shown in MLflow's UI
</p>


